{% extends 'marketplace/base.html' %}

{% block title %}Message Seller - Patch!{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- å•†å“ä¿¡æ¯å¡ç‰‡ + CheckoutæŒ‰é’® -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border sticky top-20 z-10" style="border-color: var(--light-gray);">
        <div class="flex justify-between items-center">
            <div class="flex gap-6 flex-1">
                <div class="w-24 h-24 rounded-lg overflow-hidden flex-shrink-0">
                    {% if item.images.first %}
                        <img src="{{ item.images.first.image.url }}" alt="{{ item.name }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center" style="background-color: var(--light-gray);">
                            <span class="text-2xl">ðŸŽ¨</span>
                        </div>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-semibold mb-2" style="color: var(--primary-green);">{{ item.name }}</h2>
                    <p class="text-2xl font-semibold" style="color: var(--primary-orange);">${{ item.price }}</p>
                </div>
            </div>
            <!-- Checkout æŒ‰é’® -->
            <a href="{% url 'marketplace:checkout' item.id %}" class="px-8 py-3 rounded-full font-medium btn-primary whitespace-nowrap ml-4">
                Checkout
            </a>
        </div>
    </div>

    <h1 class="text-2xl font-semibold mb-6" style="color: var(--text-black);">Messages</h1>

    <!-- å¯¹è¯æ°”æ³¡åˆ—è¡¨ - Airbnbé£Žæ ¼ -->
    <div class="space-y-3 mb-8">
        {% for msg in item_messages %}
        <!-- åˆ¤æ–­æ˜¯ä¹°å®¶è¿˜æ˜¯å–å®¶ -->
        {% if msg.sender == item.seller %}
            <!-- å–å®¶æ¶ˆæ¯ - çº¢è‰²ï¼Œå³å¯¹é½ -->
            <div class="flex justify-end">
                <div class="max-w-[70%]">
                    <div class="flex items-center justify-end gap-2 mb-1">
                        <span class="text-xs" style="color: var(--dark-gray);">{{ msg.created_at|date:"M d, H:i" }}</span>
                        <span class="text-sm font-medium" style="color: var(--primary-orange);">{{ msg.sender.username }} (Seller)</span>
                    </div>
                    <div class="rounded-2xl rounded-tr-sm px-5 py-3" style="background-color: rgba(255, 121, 90, 0.12); border: 1px solid rgba(255, 121, 90, 0.2);">
                        <p style="color: var(--text-black);">{{ msg.content }}</p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- ä¹°å®¶æ¶ˆæ¯ - ç»¿è‰²ï¼Œå·¦å¯¹é½ -->
            <div class="flex justify-start">
                <div class="max-w-[70%]">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium" style="color: var(--primary-green);">{{ msg.sender.username }}</span>
                        <span class="text-xs" style="color: var(--dark-gray);">{{ msg.created_at|date:"M d, H:i" }}</span>
                    </div>
                    <div class="rounded-2xl rounded-tl-sm px-5 py-3" style="background-color: rgba(227, 247, 196, 0.6); border: 1px solid rgba(48, 87, 81, 0.15);">
                        <p style="color: var(--text-black);">{{ msg.content }}</p>
                    </div>
                </div>
            </div>
        {% endif %}
        {% empty %}
        <div class="text-center py-16">
            <div class="mb-4">
                <span class="text-6xl">ðŸ’¬</span>
            </div>
            <p class="text-lg" style="color: var(--dark-gray);">No messages yet. Start the conversation!</p>
        </div>
        {% endfor %}
    </div>

    <!-- å‘é€æ¶ˆæ¯è¡¨å• -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border sticky bottom-4" style="border-color: var(--light-gray);">
        <h2 class="text-lg font-semibold mb-4" style="color: var(--text-black);">Send a Message</h2>
        <form method="post">
            {% csrf_token %}
            <textarea name="content" rows="3" required placeholder="Type your message here..." class="w-full px-4 py-3 border rounded-xl mb-4 focus:outline-none transition" style="border-color: var(--light-gray);" onfocus="this.style.borderColor='var(--primary-orange)'"></textarea>
            <div class="flex gap-4">
                <button type="submit" class="flex-1 py-3 rounded-full font-medium btn-primary">
                    Send Message
                </button>
                <a href="{% url 'marketplace:item_detail' item.id %}" class="flex-1 py-3 rounded-full font-medium text-center border hover:bg-gray-50 transition" style="border-color: var(--dark-gray); color: var(--dark-gray);">
                    Back
                </a>
            </div>
        </form>
    </div>
</section>
{% endblock %}